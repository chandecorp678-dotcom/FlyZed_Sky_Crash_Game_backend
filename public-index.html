<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FlyZed ‚Äì Sky Crash Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#03101f" />
  <style>
    :root{
      --bg:#081a2b; --panel:#0c223a; --accent:#FFD700; --muted:rgba(255,255,255,0.72);
      --white:#ffffff; --danger:#d7263d; --control-height:48px; --gap:10px;
    }
    * { box-sizing: border-box; }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--white);-webkit-font-smoothing:antialiased;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}

    header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:#03101f;position:sticky;top:0;z-index:30;border-bottom:1px solid rgba(255,255,255,0.03)}
    header h1{margin:0;font-size:18px;color:var(--accent);font-weight:700;display:flex;align-items:center;gap:8px}
    .header-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    .panel{padding:10px 12px;text-align:left}
    #userInfo{font-size:14px;color:var(--muted)}
    #username{font-weight:700;color:var(--white)}
    #balance{color:var(--white);font-weight:600}

    .game-box{margin:12px;border-radius:12px;background:linear-gradient(180deg,#12345a,#0a2b46);padding:20px;min-height:300px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;flex-direction:column}
    .game-content{display:flex;align-items:center;gap:30px;width:100%;justify-content:center}
    #multiplier{font-size:48px;font-weight:800;color:var(--accent);margin:0;min-width:150px;text-align:center;font-family:monospace}
    #plane{width:120px;height:60px;transition:all 0.1s linear;will-change:transform}
    #status{font-size:16px;color:var(--muted);margin-top:20px;text-align:center;width:100%;min-height:30px}

    .controls{padding:12px;display:flex;flex-direction:column;gap:10px;align-items:stretch}
    .row{display:flex;gap:8px;width:100%;align-items:center}
    input[type=number],input[type=text],input[type=password]{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071a2b;color:var(--white);flex:1;font-size:16px}
    button{cursor:pointer;border:none;border-radius:10px;padding:10px 14px;font-weight:700;transition:all 0.2s;font-size:14px}
    .primary{background:var(--accent);color:#000;padding:12px 18px;flex:1}
    .primary:hover:not(:disabled){opacity:0.9}
    .primary:disabled{opacity:0.5;cursor:not-allowed}
    .danger{background:var(--danger);color:#fff;padding:12px 18px;flex:1}
    .danger:hover:not(:disabled){opacity:0.9}
    .danger:disabled{opacity:0.5;cursor:not-allowed}
    .btn-secondary{background:rgba(255,255,255,0.1);color:var(--white)}
    .btn-secondary:hover{background:rgba(255,255,255,0.15)}

    .wallet-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .wallet-row button{background:#f0f0f0;color:#111;border-radius:8px;padding:10px 12px;font-weight:600;flex:0}

    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:1000;padding:12px}
    .modal.show{display:flex}
    .modal-content{background:var(--panel);padding:20px;border-radius:10px;color:var(--white);width:100%;max-width:450px;max-height:90vh;overflow:auto}
    .modal h3{margin-top:0;color:var(--accent)}
    .modal input{width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071a2b;color:var(--white)}
    .modal-actions{display:flex;gap:8px;margin-top:15px}
    .modal-actions button{flex:1}
    .modal-message{margin:10px 0;padding:10px;border-radius:6px;font-size:14px;display:none}
    .modal-message.error{background:#d7263d;color:#fff;display:block}
    .modal-message.success{background:#083a1f;color:#fff;display:block}

    .hidden{display:none !important}
    main{padding-bottom:120px}

    @media (max-width:600px){
      .game-content{flex-direction:column;gap:15px}
      #multiplier{font-size:36px}
      #plane{width:80px;height:40px}
      .controls{padding:10px;gap:8px}
      input[type=number]{width:100%}
      .row{flex-direction:column}
      .row input,.row button{width:100%}
    }

    button:focus,input:focus{outline:3px solid rgba(255,215,0,0.15);outline-offset:2px}
  </style>
</head>
<body>
  <header role="banner" aria-label="App header">
    <h1>üõ©Ô∏è FlyZed</h1>
    <div class="header-right">
      <button id="loginBtn" onclick="showLogin()" class="btn-secondary">Login</button>
      <button id="registerBtn" onclick="showRegister()" class="btn-secondary">Register</button>
      <button id="logoutBtn" onclick="logout()" class="btn-secondary hidden">Logout</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <div id="userInfo">Logged in as: <b id="username">Guest</b> | Balance: <b id="balance">K 10.00</b></div>
    </section>

    <section class="game-box" id="gameBox">
      <div class="game-content">
        <div>
          <div id="multiplier">1.00x</div>
        </div>
        <svg id="plane" viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M4 18 C18 18 32 16 46 12 C50 11 54 9 60 8 L58 6 C52 7 48 9 44 10 C30 14 18 16 6 18 Z" fill="#FFD54F"/>
          <path d="M18 18 L36 10 L40 12 L24 20 Z" fill="#FF7043"/>
          <path d="M22 20 L38 22 L36 24 L20 22 Z" fill="#FF7043"/>
          <path d="M6 18 L2 14 L2 18 Z" fill="#FF7043"/>
          <circle cx="46" cy="11" r="2.2" fill="rgba(0,0,0,0.6)"/>
        </svg>
      </div>
      <div id="status">‚è≥ Checking for active round...</div>
    </section>

    <section class="controls">
      <div class="row">
        <input id="betAmount" type="number" min="1" step="1" value="5" placeholder="Bet amount (K)" />
        <button class="primary" id="playBtn" onclick="startGame()">Play</button>
      </div>

      <div class="row">
		<button class="danger" id="cashOutBtn" disabled onclick="cashOut()">Cash Out</button>
		<button class="btn-secondary" id="viewProofBtn" disabled onclick="viewProof()">View Proof</button>
	</div>

	<div class="wallet-row">
		<button class="btn-secondary" onclick="deposit()">+ Deposit</button>
		<button class="btn-secondary" onclick="withdraw()">- Withdraw</button>
	</div>
    </section>
  </main>

  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <h3>Login</h3>
      <input id="loginPhone" type="text" placeholder="Phone" />
      <input id="loginPassword" type="password" placeholder="Password" />
      <div id="loginMessage" class="modal-message"></div>
      <div class="modal-actions">
        <button class="primary" onclick="login()">Login</button>
        <button class="btn-secondary" onclick="hideModals()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <h3>Register</h3>
      <input id="regName" type="text" placeholder="Name" />
      <input id="regPhone" type="text" placeholder="Phone" />
      <input id="regPassword" type="password" placeholder="Password" />
      <label style="color:var(--muted);font-size:12px;margin-bottom:10px;display:flex;gap:8px;align-items:center;">
        <input type="checkbox" id="agreeTerms" />
        I agree to Terms
      </label>
      <div id="registerMessage" class="modal-message"></div>
      <div class="modal-actions">
        <button class="primary" onclick="register()">Register</button>
        <button class="btn-secondary" onclick="hideModals()">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Proof Modal -->
  <div class="modal" id="proofModal">
    <div class="modal-content">
      <h3>üéØ Round Proof ‚Äì Verify Fairness</h3>
      
      <div style="background:#071a2b;padding:15px;border-radius:8px;margin:15px 0;">
        <p style="font-size:12px;color:var(--muted);margin:0 0 10px 0;">Server Seed:</p>
        <code style="word-break:break-all;color:var(--accent);font-size:11px;" id="proofSeed">Loading...</code>
      </div>

      <div style="background:#071a2b;padding:15px;border-radius:8px;margin:15px 0;">
        <p style="font-size:12px;color:var(--muted);margin:0 0 10px 0;">Seed Hash:</p>
        <code style="word-break:break-all;color:var(--accent);font-size:11px;" id="proofHash">Loading...</code>
      </div>

      <div style="background:#071a2b;padding:15px;border-radius:8px;margin:15px 0;">
        <p style="font-size:12px;color:var(--muted);margin:0 0 10px 0;">Crash Point:</p>
        <code style="color:var(--accent);font-size:14px;font-weight:bold;" id="proofCrash">Loading...</code>
      </div>

      <p style="font-size:12px;color:var(--muted);text-align:center;">
        ‚úÖ This crash was determined by the seed above.<br>
        You can verify using SHA256(seed) = hash shown.
      </p>

      <div class="modal-actions">
        <button class="primary" onclick="copyProof()">Copy Proof</button>
        <button class="btn-secondary" onclick="hideModals()">Close</button>
      </div>
    </div>
  </div>
  
    <!-- Terms & Conditions Modal -->
  <div class="modal" id="tcModal">
    <div class="modal-content">
      <h3>üìã Terms & Conditions</h3>
      
      <div style="max-height:300px;overflow-y:auto;background:#071a2b;padding:15px;border-radius:8px;margin:15px 0;font-size:12px;line-height:1.6;">
        <h4 style="color:var(--accent);margin-top:0;">Ka Ndeke ‚Äì Terms & Conditions</h4>
        
        <p><strong>1. ACCEPTANCE OF TERMS</strong></p>
        <p>By using Ka Ndeke, you agree to these Terms & Conditions. If you do not agree, please do not use our service.</p>
        
        <p><strong>2. AGE REQUIREMENT</strong></p>
        <p>You must be at least 18 years old to use this service. By accepting these terms, you confirm you are 18 or older.</p>
        
        <p><strong>3. NO REAL MONEY (DEMO MODE)</strong></p>
        <p>This is currently a DEMO version. No real money is involved. All balances are virtual and for testing purposes only.</p>
        
        <p><strong>4. RESPONSIBLE GAMBLING</strong></p>
        <p>Ka Ndeke promotes responsible gambling. Please gamble responsibly and within your means:</p>
        <ul style="margin:10px 0;padding-left:20px;">
          <li>Set limits on how much you spend</li>
          <li>Never gamble money you cannot afford to lose</li>
          <li>Take regular breaks</li>
          <li>Seek help if you have gambling problems</li>
        </ul>
        
        <p><strong>5. FAIR PLAY</strong></p>
        <p>All crash points are generated fairly using cryptographic seeds. You can verify fairness by viewing the proof after each round.</p>
        
        <p><strong>6. ACCOUNT RESPONSIBILITY</strong></p>
        <p>You are responsible for keeping your account credentials secret. Ka Ndeke is not liable for unauthorized access.</p>
        
        <p><strong>7. LIMITATION OF LIABILITY</strong></p>
        <p>Ka Ndeke is provided "as is" without warranties. We are not liable for losses incurred through gameplay.</p>
        
        <p><strong>8. CHANGES TO TERMS</strong></p>
        <p>Ka Ndeke may update these terms at any time. Continued use constitutes acceptance.</p>
        
        <p style="text-align:center;font-size:11px;color:var(--muted);margin-top:20px;">
          Last Updated: 2026-02-12<br>
          ¬© 2026 Ka Ndeke. All rights reserved.
        </p>
      </div>

      <label style="display:flex;gap:8px;align-items:flex-start;margin:15px 0;color:var(--muted);font-size:13px;">
        <input type="checkbox" id="tcAgree" style="margin-top:3px;cursor:pointer;flex-shrink:0;">
        <span>I have read and accept the Terms & Conditions</span>
      </label>

      <label style="display:flex;gap:8px;align-items:flex-start;margin:15px 0;color:var(--muted);font-size:13px;">
        <input type="checkbox" id="ageConfirm" style="margin-top:3px;cursor:pointer;flex-shrink:0;">
        <span>I confirm I am 18 years old or older</span>
      </label>

      <div id="tcMessage" class="modal-message"></div>

      <div class="modal-actions">
        <button class="primary" onclick="acceptTC()">Accept & Continue</button>
        <button class="btn-secondary" onclick="rejectTC()">Decline</button>
      </div>
    </div>
  </div>

  <!-- Responsible Gaming Warning Modal -->
  <div class="modal" id="gamingWarningModal">
    <div class="modal-content">
      <h3>‚ö†Ô∏è Responsible Gaming</h3>
      
      <div style="background:#d7263d;padding:15px;border-radius:8px;margin:15px 0;color:white;font-size:14px;line-height:1.6;">
        <p style="margin-top:0;"><strong>üéÆ Gaming Reminder</strong></p>
        <p>You've been playing for a while. Remember to:</p>
        <ul style="margin:10px 0;padding-left:20px;">
          <li>Take a break</li>
          <li>Only gamble what you can afford to lose</li>
          <li>Never chase losses</li>
          <li>Set time and money limits</li>
        </ul>
        <p style="margin-bottom:0;font-size:12px;opacity:0.9;">If you have gambling concerns, please seek help.</p>
      </div>

      <div class="modal-actions">
        <button class="primary" onclick="hideModals()">I Understand</button>
        <button class="btn-secondary" onclick="selfExclude()">Self-Exclude</button>
      </div>
    </div>
  </div>
  
  <script>
    const API_BASE = 'https://ka-ndeke-backend-5dgy.onrender.com/api';
    const TOKEN_KEY = 'flyzed_token';

    let authMode = null;
    let currentUser = null;
    let guestBalance = 10;
    let running = false;
    let currentBet = 0;
    let multiplier = 1.0;
    let crashed = false;
    let roundActive = false;
    let statusPoller = null;
	let currentRoundId = null;  // Track current round ID for proof viewing
	let tcAccepted = false;  // Track if user accepted T&C
	let gamingWarningShown = false;  // Track if warning shown this session
	let warningTimer = null;  // Timer for 30-min warning

    const loginModal = document.getElementById('loginModal');
    const registerModal = document.getElementById('registerModal');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // ‚úÖ FIXED apiFetch function
    async function apiFetch(path, opts = {}, withAuth = true) {
      const url = API_BASE + path;
      const headers = opts.headers || {};

      if (withAuth) {
        const token = localStorage.getItem(TOKEN_KEY);
        if (token) headers['Authorization'] = 'Bearer ' + token;
      }

      // ‚úÖ FIX: Create a new object for body, don't reuse opts.body
      let body = null;
      if (opts.body) {
        if (typeof opts.body === 'object') {
          body = JSON.stringify(opts.body);
          headers['Content-Type'] = 'application/json';
        } else {
          body = opts.body;
        }
      }

      try {
        const res = await fetch(url, { 
          method: opts.method || 'GET',
          headers: headers,
          body: body
        });
        
        const text = await res.text();
        let json = null;

        try {
          json = text ? JSON.parse(text) : null;
        } catch (e) {
          json = null;
        }

        if (!res.ok) {
          throw new Error(json?.error || `HTTP ${res.status}`);
        }

        return json;
      } catch (err) {
        console.error(`[API] ${path}:`, err.message);
        throw err;
      }
    }

    function updateUI() {
      const name = authMode ? (currentUser?.username || 'User') : 'Guest';
      const balance = authMode ? (currentUser?.balance || 0) : guestBalance;

      document.getElementById('username').textContent = name;
      document.getElementById('balance').textContent = 'K ' + Number(balance).toFixed(2);

      loginBtn.classList.toggle('hidden', !!authMode);
      registerBtn.classList.toggle('hidden', !!authMode);
      logoutBtn.classList.toggle('hidden', !authMode);
    }

    function showLogin() {
      document.getElementById('loginPhone').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginMessage').textContent = '';
      document.getElementById('loginMessage').className = 'modal-message';
      loginModal.classList.add('show');
    }

    function showRegister() {
      document.getElementById('regName').value = '';
      document.getElementById('regPhone').value = '';
      document.getElementById('regPassword').value = '';
      document.getElementById('agreeTerms').checked = false;
      document.getElementById('registerMessage').textContent = '';
      document.getElementById('registerMessage').className = 'modal-message';
      registerModal.classList.add('show');
    }

    function hideModals() {
      loginModal.classList.remove('show');
      registerModal.classList.remove('show');
	  document.getElementById('proofModal').classList.remove('show');
	  document.getElementById('tcModal').classList.remove('show');
	  document.getElementById('gamingWarningModal').classList.remove('show');
    }

    function showMessage(modalId, message, isError) {
      const el = document.getElementById(modalId);
      el.textContent = message;
      el.className = `modal-message ${isError ? 'error' : 'success'}`;
    }

    async function pollRoundStatus() {
      try {
        const status = await apiFetch('/game/status', { method: 'GET' }, false);
        
        if (!status) return;

        let liveMultiplier = 1.0;
        if (status.startedAt && status.status === 'running') {
          const startedMs = Number(status.startedAt);
          const elapsedMs = Date.now() - startedMs;
          const elapsedSec = elapsedMs / 1000;
          liveMultiplier = 1 + (elapsedSec * 0.5);
        } else if (status.multiplier) {
          liveMultiplier = Number(status.multiplier);
        }

        document.getElementById('multiplier').textContent = liveMultiplier.toFixed(2) + 'x';
        
        const planeEl = document.getElementById('plane');
        const translateX = Math.min(300, liveMultiplier * 30);
        const translateY = liveMultiplier * -20;
        planeEl.style.transform = `translateX(${translateX}px) translateY(${translateY}px) rotate(${liveMultiplier * 5}deg)`;

        if (status.status === 'running' && !roundActive) {
          roundActive = true;
          document.getElementById('status').textContent = 'üéÆ Round active! Place your bet.';
        }

        if (status.status === 'crashed' && roundActive) {
		  roundActive = false;
		  crashed = true;
		  running = false;
          document.getElementById('status').textContent = `üí• Crashed at ${liveMultiplier.toFixed(2)}x`;
          document.getElementById('cashOutBtn').disabled = true;
          document.getElementById('playBtn').disabled = false;
          document.getElementById('viewProofBtn').disabled = false;  // Enable proof viewing
		}
      } catch (err) {
        // Silently fail
      }
    }

    statusPoller = setInterval(pollRoundStatus, 250);

    async function register() {
  const username = document.getElementById('regName').value;
  const phone = document.getElementById('regPhone').value;
  const password = document.getElementById('regPassword').value;
  const agreed = document.getElementById('agreeTerms').checked;

  console.log('Sending register:', { username, phone, password, agreed });

  try {
    const data = await apiFetch('/auth/register', {
      method: 'POST',
      body: { username, phone, password }
    }, false);

    localStorage.setItem(TOKEN_KEY, data.token);
    currentUser = data.user;
    authMode = 'server';
    updateUI();
    
    // Close register modal and show T&C modal
    document.getElementById('registerModal').classList.remove('show');
    showTC();
    
  } catch (err) {
    console.error('Register error:', err);
    showMessage('registerMessage', err.message || 'Registration failed', true);
  }
}

    async function login() {
  const phone = document.getElementById('loginPhone').value;
  const password = document.getElementById('loginPassword').value;

  console.log('Sending login:', { phone, password });

  try {
    const data = await apiFetch('/auth/login', {
      method: 'POST',
      body: { phone, password }
    }, false);

    localStorage.setItem(TOKEN_KEY, data.token);
    currentUser = data.user;
    authMode = 'server';
    updateUI();

    showMessage('loginMessage', 'Login successful!', false);
    
    setTimeout(() => {
      hideModals();
      // Check if need to accept T&C
      apiFetch('/legal/compliance-status', {}, true)
        .then(res => {
          if (!res.status.compliant) {
            showTC();
          } else {
            tcAccepted = true;
          }
        })
        .catch(() => {
          tcAccepted = true;
        });
    }, 1000);
    
  } catch (err) {
    console.error('Login error:', err);
    showMessage('loginMessage', err.message || 'Login failed', true);
  }
}

    function logout() {
      localStorage.removeItem(TOKEN_KEY);
      currentUser = null;
      authMode = null;
      guestBalance = 10;
      updateUI();
    }

    async function startGame() {
	// CHECK: Has user accepted T&C?
	  if (authMode === 'server' && !tcAccepted) {
		try {
		const compliance = await apiFetch('/legal/compliance-status', {}, true);
      if (!compliance.status.compliant) {
        alert('‚ö†Ô∏è You must accept Terms & Conditions before playing');
        showTC();
        return;
      }
      tcAccepted = true;
    } catch (err) {
      console.warn('Could not check compliance:', err);
    }
  }

  // Show gaming warning after 30 minutes
  if (warningTimer) clearTimeout(warningTimer);
  warningTimer = setTimeout(() => {
    showGamingWarning();
  }, 30 * 60 * 1000); // 30 minutes
  
      if (running) return alert('Round already in progress');

      const bet = Number(document.getElementById('betAmount').value);
      if (bet <= 0) return alert('Invalid bet amount');

      if (authMode === 'server') {
        if (!currentUser || bet > currentUser.balance) {
          return alert('Insufficient balance');
        }
      } else {
        if (bet > guestBalance) {
          return alert('Insufficient balance (guest)');
        }
      }

      try {
        const data = await apiFetch('/game/start', {
          method: 'POST',
          body: { betAmount: bet }
        }, true);

        currentBet = bet;
        multiplier = 1.0;
        running = true;
        crashed = false;

        if (authMode === 'server') {
          currentUser.balance = Number(data.balance) || 0;
        } else {
          guestBalance -= bet;
        }

        updateUI();
        document.getElementById('cashOutBtn').disabled = false;
        document.getElementById('playBtn').disabled = true;
        document.getElementById('status').textContent = '‚úàÔ∏è Bet placed!';
        document.getElementById('multiplier').textContent = '1.00x';
		currentRoundId = data.roundId;  // Save round ID for later proof viewing
		document.getElementById('viewProofBtn').disabled = true;  // Disable until crash

      } catch (err) {
        alert('Failed to start round: ' + err.message);
      }
    }

    async function cashOut() {
      if (crashed) return alert('Too late!');
      if (!running) return alert('No active game');

      try {
        const data = await apiFetch('/game/cashout', {
          method: 'POST',
          body: {}
        }, true);

        running = false;
        crashed = true;
        document.getElementById('cashOutBtn').disabled = true;
        document.getElementById('playBtn').disabled = false;

        if (data.success) {
          const payout = Number(data.payout);
          if (authMode === 'server') {
            currentUser.balance = Number(data.balance) || 0;
          } else {
            guestBalance += payout;
          }
          updateUI();
          document.getElementById('status').textContent = `‚úÖ Won K ${payout.toFixed(2)}!`;
        } else {
          document.getElementById('status').textContent = `üí• Lost!`;
        }
      } catch (err) {
        alert('Cash out failed: ' + err.message);
      }
    }

    // ============ DEPOSIT ============
    async function deposit() {
      const amountStr = prompt('Enter deposit amount:');
      if (!amountStr) return;
      
      const amount = Number(amountStr);
      
      console.log('üîç Deposit:', { amountStr, amount, authMode });
      
      if (isNaN(amount) || amount <= 0) {
        alert('Enter a valid amount greater than 0');
        return;
      }

      if (!authMode) {
        guestBalance += amount;
        updateUI();
        alert('Deposit applied (guest)');
        return;
      }

      try {
        console.log('üì§ Sending deposit request with amount:', amount);
        const responseData = await apiFetch('/users/deposit', {
          method: 'POST',
          body: { amount: amount }
        }, true);

        console.log('üì• Response:', responseData);

        if (!responseData) {
          alert('No data returned from server');
          return;
        }

        currentUser = {
          id: responseData.id,
          username: responseData.username,
          phone: responseData.phone,
          balance: Number(responseData.balance) || 0,
          freeRounds: Number(responseData.freeRounds || responseData.freerounds) || 0,
          createdAt: responseData.createdAt,
          updatedAt: responseData.updatedAt
        };

        console.log('‚úÖ currentUser updated:', currentUser);
        updateUI();
        alert('Deposit successful! New balance: K ' + currentUser.balance.toFixed(2));
      } catch (err) {
        console.error('‚ùå Deposit error:', err);
        alert('Deposit failed: ' + err.message);
      }
    }

    // ============ WITHDRAW ============
    async function withdraw() {
      const amountStr = prompt('Enter withdrawal amount:');
      if (!amountStr) return;
      
      const amount = Number(amountStr);
      
      console.log('üîç Withdraw:', { amountStr, amount, authMode });
      
      if (isNaN(amount) || amount <= 0) {
        alert('Enter a valid amount greater than 0');
        return;
      }

      if (!authMode) {
        if (amount > guestBalance) {
          alert('Insufficient balance');
          return;
        }
        guestBalance -= amount;
        updateUI();
        alert('Withdrawal applied (guest)');
        return;
      }

      try {
        console.log('üì§ Sending withdraw request with amount:', amount);
        const responseData = await apiFetch('/users/withdraw', {
          method: 'POST',
          body: { amount: amount }
        }, true);

        console.log('üì• Response:', responseData);

        if (!responseData) {
          alert('No data returned from server');
          return;
        }

        currentUser = {
          id: responseData.id,
          username: responseData.username,
          phone: responseData.phone,
          balance: Number(responseData.balance) || 0,
          freeRounds: Number(responseData.freeRounds || responseData.freerounds) || 0,
          createdAt: responseData.createdAt,
          updatedAt: responseData.updatedAt
        };

        console.log('‚úÖ currentUser updated:', currentUser);
        updateUI();
        alert('Withdrawal successful! New balance: K ' + currentUser.balance.toFixed(2));
      } catch (err) {
        console.error('‚ùå Withdraw error:', err);
        alert('Withdrawal failed: ' + err.message);
      }
    }

    updateUI();

    [loginModal, registerModal].forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) hideModals();
      });
    });

    (async () => {
      const token = localStorage.getItem(TOKEN_KEY);
      if (token) {
        try {
          const user = await apiFetch('/users/me', { method: 'GET' }, true);
          currentUser = user;
          authMode = 'server';
          updateUI();
        } catch (err) {
          localStorage.removeItem(TOKEN_KEY);
          updateUI();
        }
      }
    })();
	// ============ STAGE 7: PROVABLY FAIR ============

async function viewProof() {
  if (!currentRoundId) {
    alert('No round to prove');
    return;
  }

  try {
    console.log('Fetching proof for round:', currentRoundId);
    
    const proof = await apiFetch(`/game/reveal/${currentRoundId}`);
    
    console.log('Proof received:', proof);
    
    // Display proof in modal
    document.getElementById('proofSeed').textContent = proof.serverSeed || 'Not available';
    document.getElementById('proofHash').textContent = proof.serverSeedHash || 'Not available';
    document.getElementById('proofCrash').textContent = (proof.crashPoint || 'N/A') + 'x';
    
    // Show modal
    document.getElementById('proofModal').classList.add('show');
    
  } catch (err) {
    console.error('Error fetching proof:', err);
    alert('Error loading proof: ' + err.message);
  }
}

function copyProof() {
  const seed = document.getElementById('proofSeed').textContent;
  const hash = document.getElementById('proofHash').textContent;
  const crash = document.getElementById('proofCrash').textContent;
  
  const proofText = `Server Seed: ${seed}\nSeed Hash: ${hash}\nCrash Point: ${crash}`;
  
  navigator.clipboard.writeText(proofText).then(() => {
    alert('‚úÖ Proof copied to clipboard');
  }).catch(() => {
    alert('Could not copy to clipboard');
  });
}

// ============ END STAGE 7 ============
// ============ STAGE 11: LEGAL COMPLIANCE ============

async function showTC() {
  document.getElementById('tcAgree').checked = false;
  document.getElementById('ageConfirm').checked = false;
  document.getElementById('tcMessage').className = 'modal-message';
  document.getElementById('tcMessage').textContent = '';
  document.getElementById('tcModal').classList.add('show');
}

async function acceptTC() {
  const tcChecked = document.getElementById('tcAgree').checked;
  const ageChecked = document.getElementById('ageConfirm').checked;

  if (!tcChecked || !ageChecked) {
    const msg = document.getElementById('tcMessage');
    msg.className = 'modal-message error';
    msg.textContent = '‚ùå You must accept both terms and confirm your age';
    return;
  }

  try {
    // Accept T&C on backend
    await apiFetch('/legal/accept-terms', {
      method: 'POST',
      body: {}
    }, true);

    // Verify age on backend
    await apiFetch('/legal/verify-age', {
      method: 'POST',
      body: { confirmed: true }
    }, true);

    tcAccepted = true;
    document.getElementById('tcModal').classList.remove('show');
    
    const msg = document.getElementById('tcMessage');
    msg.className = 'modal-message success';
    msg.textContent = '‚úÖ You can now play!';
    
    console.log('‚úÖ User accepted T&C and verified age');
    
  } catch (err) {
    console.error('Error accepting T&C:', err);
    const msg = document.getElementById('tcMessage');
    msg.className = 'modal-message error';
    msg.textContent = '‚ùå Error: ' + err.message;
  }
}

function rejectTC() {
  const msg = document.getElementById('tcMessage');
  msg.className = 'modal-message error';
  msg.textContent = '‚ùå You cannot play without accepting the terms';
  
  // Hide modal after 2 seconds
  setTimeout(() => {
    document.getElementById('tcModal').classList.remove('show');
    document.getElementById('registerModal').classList.remove('show');
    loginModal.classList.remove('show');
  }, 2000);
}

function showGamingWarning() {
  if (!gamingWarningShown && running) {
    document.getElementById('gamingWarningModal').classList.add('show');
    gamingWarningShown = true;
  }
}

function selfExclude() {
  const days = prompt('Self-exclude for how many days?\n7 = 1 week\n30 = 1 month\n90 = 3 months\n\nEnter: 7, 30, or 90');
  
  if (!days) return;
  
  const daysNum = Number(days);
  if (![7, 30, 90].includes(daysNum)) {
    alert('Invalid. Please enter 7, 30, or 90');
    return;
  }
  
  if (confirm(`Are you sure? You will be unable to play for ${daysNum} days.`)) {
    apiFetch('/legal/self-exclude', {
      method: 'POST',
      body: { days: daysNum }
    }, true).then(() => {
      alert(`‚úÖ You are self-excluded for ${daysNum} days. Contact support to appeal.`);
      logout();
    }).catch(err => {
      alert('Error: ' + err.message);
    });
  }
}

// ============ END STAGE 11 ============
  </script>
</body>
</html>
