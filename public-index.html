<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ka Ndeke ‚Äì Aviator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#03101f">

  <style>
    /* Base layout */
    :root{
      --bg:#081a2b;
      --panel:#0c223a;
      --accent:#FFD700;
      --muted:rgba(255,255,255,0.72);
      --white:#ffffff;
      --danger:#d7263d;
      --control-height:48px;
      --gap:10px;
    }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--white);-webkit-font-smoothing:antialiased;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}

    /* Header */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      background:#03101f;
      position:sticky;
      top:0;
      z-index:30;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    header h1{margin:0;font-size:18px;color:var(--accent);font-weight:700;display:flex;align-items:center;gap:8px}
    .header-right{display:flex;align-items:center;gap:8px}

    /* Panel & user info */
    .panel{padding:10px 12px; text-align:left}
    #userInfo{font-size:14px;color:var(--muted)}
    #username{font-weight:700;color:var(--white)}
    #balance{color:var(--white);font-weight:600}

    /* Game area */
    .game-box{
      margin:12px;
      border-radius:12px;
      background:linear-gradient(180deg,#12345a,#0a2b46);
      padding:10px;
      min-height:220px;
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
    }
    #multiplier{font-size:28px;font-weight:800;color:var(--white);margin-left:8px}
    #plane{width:72px;transition:transform 0.08s linear;will-change:transform}

    /* Controls */
    .controls{padding:12px;display:flex;flex-direction:column;gap:10px;align-items:center}
    .row{display:flex;gap:8px;width:100%;align-items:center}
    input[type=number]{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071a2b;color:var(--white);width:140px;text-align:center;font-size:16px}
    button{cursor:pointer;border:none;border-radius:10px;padding:10px 14px;font-weight:700}
    .primary{background:var(--accent);color:#000;padding:12px 18px}
    .danger{background:var(--danger);color:#fff;padding:12px 18px}

    /* Wallet buttons small */
    .wallet-row{display:flex;gap:10px;justify-content:center}
    .wallet-row button{background:#f0f0f0;color:#111;border-radius:8px;padding:10px 12px;font-weight:600}

    /* Buttons full-width on small screens */
    .controls .full{width:100%}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.72);z-index:40;padding:12px}
    .modal-content{width:100%;max-width:420px;background:var(--panel);border-radius:10px;padding:14px;color:var(--white);box-shadow:0 6px 18px rgba(0,0,0,0.5)}
    .modal h3{margin-top:0;margin-bottom:8px}
    .modal .flex{display:flex;gap:10px}

    /* History list */
    .history-list{max-height:58vh;overflow:auto}
    .history-item{padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .history-item .meta{font-size:12px;color:var(--muted)}

    /* Responsive: small devices */
    @media (max-width:520px){
      #multiplier{font-size:22px}
      #plane{width:56px}
      .game-box{min-height:180px;margin:10px;border-radius:10px;padding:8px}
      .controls{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(180deg, rgba(8,26,43,0.2), var(--bg));border-top:1px solid rgba(255,255,255,0.03)}
      .controls .row{flex-direction:row;align-items:center}
      input[type=number]{width:100%;flex:1}
      .controls .full{width:48%}
      .wallet-row{flex-direction:row;gap:10px}
      .modal-content{max-width:95%;padding:12px}
      .history-list{max-height:60vh}
    }

    /* Accessibility focus styles */
    button:focus, input:focus{outline:3px solid rgba(255,215,0,0.15);outline-offset:2px}

    /* Small badges / metrics */
    .badge{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;font-size:13px}
    #metrics{font-size:13px;color:var(--muted);margin-right:6px}

  </style>
</head>
<body>
  <header role="banner" aria-label="App header">
    <h1 aria-hidden="true">‚úàÔ∏è Ka Ndeke</h1>
    <div class="header-right" role="navigation" aria-label="Top controls">
      <div id="metrics" class="badge" aria-live="polite">Loading‚Ä¶</div>
      <button id="historyBtn" class="badge" onclick="showHistory()" aria-label="Show game history">History</button>
      <button id="loginBtn" onclick="showLogin()" aria-label="Login">Login</button>
      <button id="registerBtn" onclick="showRegister()" aria-label="Register">Register</button>
      <button id="logoutBtn" onclick="logout()" class="hidden" aria-label="Logout">Logout</button>
      <button id="guestBtn" onclick="useGuest()" aria-label="Use guest mode">Guest</button>
    </div>
  </header>

  <main role="main" style="padding-bottom:80px;">
    <section class="panel" aria-label="User info">
      <div id="userInfo">Logged in as: <b id="username">Guest</b> ‚Äî Balance: <b id="balance">ZMW 10.00</b></div>
    </section>

    <section class="game-box" aria-live="polite" aria-atomic="true">
      <div style="display:flex;flex-direction:column;gap:6px;">
        <div id="multiplier" aria-hidden="true">1.00x</div>
        <svg id="plane" viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M4 18 C18 18 32 16 46 12 C50 11 54 9 60 8 L58 6 C52 7 48 9 44 10 C30 14 18 16 6 18 Z" fill="#FFD54F"/>
          <path d="M18 18 L36 10 L40 12 L24 20 Z" fill="#FF7043"/>
          <path d="M22 20 L38 22 L36 24 L20 22 Z" fill="#FF7043"/>
          <path d="M6 18 L2 14 L2 18 Z" fill="#FF7043"/>
          <circle cx="46" cy="11" r="2.2" fill="rgba(0,0,0,0.6)"/>
        </svg>
      </div>
    </section>

    <section class="controls" role="region" aria-label="Game controls">
      <div class="row" style="width:100%;">
        <input id="betAmount" type="number" min="1" step="1" value="5" aria-label="Bet amount" />
        <button class="primary full" onclick="startGame()" aria-label="Start game">Play</button>
      </div>

      <div class="row" style="width:100%;">
        <button id="cashOutBtn" class="danger full" disabled onclick="cashOut()" aria-label="Cash out">Cash Out</button>
      </div>

      <div class="wallet-row" style="margin-top:6px;">
        <button onclick="deposit()" aria-label="Deposit">Deposit ZMW</button>
        <button onclick="withdraw()" aria-label="Withdraw">Withdraw ZMW</button>
      </div>
    </section>
  </main>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-content">
      <h3 id="loginTitle">Login</h3>
      <input id="loginPhone" placeholder="Phone number" aria-label="Phone number" />
      <input id="loginPassword" type="password" placeholder="Password" aria-label="Password" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button class="primary" onclick="login()">Submit</button>
        <button onclick="hideModals()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="registerTitle">
    <div class="modal-content">
      <h3 id="registerTitle">Register</h3>
      <input id="regName" placeholder="Full name" aria-label="Full name" />
      <input id="regPhone" placeholder="Phone number" aria-label="Phone number" />
      <input id="regPassword" type="password" placeholder="Password" aria-label="Password" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button class="primary" onclick="register()">Submit</button>
        <button onclick="hideModals()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
    <div class="modal-content">
      <h3 id="historyTitle">Recent Rounds</h3>
      <div id="historyContainer" class="history-list" aria-live="polite"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button onclick="loadHistory()">Refresh</button>
        <button onclick="hideHistory()">Close</button>
      </div>
    </div>
  </div>

  <!-- Round Detail Modal -->
  <div id="roundModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="roundTitle">
    <div class="modal-content" id="roundContent">
      <h3 id="roundTitle">Round</h3>
      <div id="roundBody"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button onclick="closeRound()">Close</button>
      </div>
    </div>
  </div>

<script>
/* Lightweight, mobile-first frontend script (keeps prior logic, optimized) */

const API = "https://ka-ndeke-backend-5dgy.onrender.com/api";
let user = { guest: true };
let balance = Number(localStorage.getItem("guest_balance") || 10);
let running = false;
let currentBet = 0;
let roundCrashed = false;
let currentRoundId = null;
let statusPoller = null;
let spectatorPoller = null;

/* UI references */
const loginModal = document.getElementById("loginModal");
const registerModal = document.getElementById("registerModal");
const historyModal = document.getElementById("historyModal");
const roundModal = document.getElementById("roundModal");
const loginBtn = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");
const logoutBtn = document.getElementById("logoutBtn");
const guestBtn = document.getElementById("guestBtn");

/* Basic UI update */
function updateUI(){
  document.getElementById("username").textContent = user.guest ? "Guest" : (user.username || user.name || "User");
  document.getElementById("balance").textContent = "ZMW " + Number(balance || 0).toFixed(2);
  if (user.guest) {
    logoutBtn.classList.add("hidden");
    loginBtn.classList.remove("hidden");
    registerBtn.classList.remove("hidden");
    guestBtn.classList.remove("hidden");
  } else {
    logoutBtn.classList.remove("hidden");
    loginBtn.classList.add("hidden");
    registerBtn.classList.add("hidden");
    guestBtn.classList.add("hidden");
  }
}
updateUI();

/* modal helpers */
function show(el){ el.style.display = "flex"; }
function hide(el){ el.style.display = "none"; }
function showLogin(){ show(loginModal); }
function showRegister(){ show(registerModal); }
function hideModals(){ hide(loginModal); hide(registerModal); }
function showHistory(){ show(historyModal); loadHistory(); }
function hideHistory(){ hide(historyModal); }
function showRoundModal(){ show(roundModal); }
function closeRound(){ hide(roundModal); }

/* Touch-friendly spectator poll */
function startSpectatorPoll(intervalMs = 250){
  if (spectatorPoller) return;
  spectatorPoller = setInterval(async ()=>{
    try{
      if (running) { stopSpectatorPoll(); return; }
      const res = await fetch(`${API}/game/status`);
      if (!res.ok) return;
      const data = await res.json().catch(()=>null);
      if (!data) return;
      let liveMult = 1;
      if (data.startedAt) {
        const elapsedMs = Date.now() - Number(data.startedAt);
        liveMult = 1 + (elapsedMs/1000) * 1;
      } else if (data.multiplier) {
        liveMult = Number(data.multiplier);
      }
      if (data.status === "crashed") {
        renderMultiplierAndPlane(data.multiplier ?? data.crashPoint ?? 1);
        return;
      }
      renderMultiplierAndPlane(liveMult);
    }catch(e){ console.warn("spectator error", e); }
  }, intervalMs);
}
function stopSpectatorPoll(){ if (spectatorPoller){ clearInterval(spectatorPoller); spectatorPoller = null; } }
startSpectatorPoll();

/* render */
function renderMultiplierAndPlane(mult){
  const m = Number(Number(mult || 1).toFixed(2));
  const multEl = document.getElementById("multiplier");
  const planeEl = document.getElementById("plane");
  if (multEl) multEl.textContent = m.toFixed(2) + "x";
  if (planeEl) {
    const x = Math.min(120, m * 14);
    const y = m * -5;
    planeEl.style.transform = `translate(${x}px, ${y}px)`;
  }
}

/* helper: get headers including token */
function authHeaders(){
  const token = localStorage.getItem("token");
  const headers = { "Content-Type":"application/json" };
  if (token) headers["Authorization"] = "Bearer " + token;
  return headers;
}

/* START GAME */
async function startGame(){
  if (running) return;
  const bet = Number(document.getElementById("betAmount").value);
  if (!bet || isNaN(bet) || bet <= 0) return alert("Invalid bet amount");
  try {
    const res = await fetch(API + "/game/start", { method:"POST", headers:authHeaders(), body: JSON.stringify({ betAmount: bet }) });
    const data = await res.json().catch(()=>({}));
    if (!res.ok) return alert(data.error || "Failed to start round");
    if (data.balance !== undefined) { balance = Number(data.balance); updateUI(); }
    currentRoundId = data.roundId;
    currentBet = bet;
    running = true; roundCrashed = false; updateUI();

    if (statusPoller) { clearInterval(statusPoller); statusPoller = null; }
    statusPoller = setInterval(async ()=>{
      try{
        const r = await fetch(`${API}/game/status`);
        if (!r.ok) return;
        const d = await r.json().catch(()=>null); if (!d) return;
        let liveMult = 1;
        if (d.startedAt) { const elapsedMs = Date.now() - Number(d.startedAt); liveMult = 1 + (elapsedMs/1000) * 1; }
        else if (d.multiplier) liveMult = Number(d.multiplier);
        if (!running) return;
        if (d.status === "running") { renderMultiplierAndPlane(liveMult); document.getElementById("cashOutBtn").disabled = false; }
        else if (d.status === "crashed") {
          renderMultiplierAndPlane(d.multiplier ?? d.crashPoint ?? 1);
          alert("üí• CRASHED");
          running = false; roundCrashed = true; document.getElementById("cashOutBtn").disabled = true;
          currentRoundId = null; currentBet = 0; renderMultiplierAndPlane(1);
        }
      }catch(e){ console.error("player poll", e); }
    }, 140);

  }catch(err){ console.error("startGame", err); alert("Failed to start round"); }
}

/* CASH OUT */
async function cashOut(){
  if (roundCrashed) { alert("Too late ‚Äî round already crashed"); return; }
  try {
    const st = await fetch(`${API}/game/status`); const stdata = await st.json().catch(()=>({}));
    if (stdata.status === "crashed") { alert("Round already crashed"); return; }
  } catch(e){ console.warn("status fetch failed", e); alert("Round status unclear"); return; }
  if (!running) { alert("No active round"); return; }
  running = false;
  if (statusPoller){ clearInterval(statusPoller); statusPoller = null; }
  document.getElementById("cashOutBtn").disabled = true;
  try {
    const res = await fetch(API + "/game/cashout", { method:"POST", headers: authHeaders(), body: JSON.stringify({}) });
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.error || "Cash out failed");
    if (data.balance !== undefined) { balance = Number(data.balance); updateUI(); }
    if (data.win) alert("You won ZMW " + Number(data.payout).toFixed(2)); else alert("Crashed!");
  } catch (err) { alert(err.message || "Cash out failed"); return; }
  currentRoundId = null; currentBet = 0; roundCrashed = false; renderMultiplierAndPlane(1); updateUI();
}

/* AUTH */
async function refreshBalance(){
  const token = localStorage.getItem("token"); if (!token) return;
  try {
    const res = await fetch(API + "/users/me", { headers: { "Authorization":"Bearer " + token } });
    const data = await res.json().catch(()=>null);
    if (res.ok && data) { balance = Number(data.balance ?? balance); user = data; updateUI(); }
  }catch(e){ console.warn("refreshBalance", e); }
}

async function login(){
  if (!loginPhone.value || !loginPassword.value) return alert("Phone and password required");
  try{
    const res = await fetch(API + "/auth/login", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ phone: loginPhone.value, password: loginPassword.value })});
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.error || "Login failed");
    localStorage.setItem("token", data.token); user = data.user ?? { guest:false }; balance = Number(data.user?.balance ?? balance);
    hideModals(); updateUI(); fetchPublicMetrics(); refreshBalance();
  }catch(e){ alert(e.message || "Login failed"); }
}

async function register(){
  if (!regName.value || !regPhone.value || !regPassword.value) return alert("Username, phone and password required");
  try{
    const res = await fetch(API + "/auth/register", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ username: regName.value, phone: regPhone.value, password: regPassword.value })});
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.error || "Register failed");
    localStorage.setItem("token", data.token); user = data.user ?? { guest:false }; balance = Number(data.user?.balance ?? balance);
    hideModals(); updateUI(); fetchPublicMetrics(); refreshBalance();
  }catch(e){ alert(e.message || "Register failed"); }
}

function logout(){
  user = { guest:true }; const stored = localStorage.getItem("guest_balance"); balance = stored !== null ? Number(stored) : 10;
  localStorage.removeItem("token"); updateUI(); fetchPublicMetrics();
}

function useGuest(){ user = { guest:true }; const stored = localStorage.getItem("guest_balance"); balance = stored !== null ? Number(stored) : 10; updateUI(); }

/* WALLET (keeps previous behaviour) */
async function deposit(){
  const amt = prompt("Enter deposit amount"); if (!amt || isNaN(amt) || amt <= 0) return alert("Invalid amount");
  if (user.guest) { balance += Number(amt); localStorage.setItem("guest_balance", balance); updateUI(); alert("Deposit (guest)"); return; }
  const token = localStorage.getItem("token"); if (!token) return alert("Must be logged in");
  try{
    const res = await fetch(API + "/users/deposit", { method:"POST", headers: {"Content-Type":"application/json","Authorization":"Bearer " + token}, body: JSON.stringify({ amount: Number(amt) })});
    const data = await res.json().catch(()=>({}));
    if (!res.ok) return alert(data.error || "Deposit failed");
    if (data.balance !== undefined) { balance = Number(data.balance); user = data; updateUI(); } else refreshBalance();
    alert("Deposit succeeded"); fetchPublicMetrics();
  }catch(e){ console.error("deposit", e); alert("Deposit error"); }
}

async function withdraw(){
  const amt = prompt("Enter withdraw amount"); if (!amt || isNaN(amt) || amt <= 0) return alert("Invalid amount");
  if (user.guest) { if (amt > balance) return alert("Insufficient balance"); balance -= Number(amt); localStorage.setItem("guest_balance", balance); updateUI(); return; }
  const token = localStorage.getItem("token"); if (!token) return alert("Must be logged in");
  try{
    const res = await fetch(API + "/users/withdraw", { method:"POST", headers: {"Content-Type":"application/json","Authorization":"Bearer " + token}, body: JSON.stringify({ amount: Number(amt) })});
    const data = await res.json().catch(()=>({}));
    if (!res.ok) return alert(data.error || "Withdraw failed");
    if (data.balance !== undefined) { balance = Number(data.balance); user = data; updateUI(); } else refreshBalance();
    alert("Withdraw succeeded"); fetchPublicMetrics();
  }catch(e){ console.error("withdraw", e); alert("Withdraw error"); }
}

/* HISTORY UI */
let lastHistoryFetch = 0;
async function loadHistory(limit = 20){
  try{
    const now = Date.now();
    // throttle rapid refreshes from UI
    if (now - lastHistoryFetch < 1200) return;
    lastHistoryFetch = now;
    const container = document.getElementById("historyContainer");
    container.innerHTML = '<div class="meta">Loading‚Ä¶</div>';
    const res = await fetch(`${API}/game/history?limit=${limit}`);
    const data = await res.json().catch(()=>null);
    if (!res.ok || !data || !Array.isArray(data.rounds)) { container.innerHTML = '<div class="meta">Unable to load history</div>'; return; }
    if (!data.rounds.length) { container.innerHTML = '<div class="meta">No rounds recorded yet</div>'; return; }
    container.innerHTML = '';
    data.rounds.forEach(r => {
      const item = document.createElement("div");
      item.className = "history-item";
      const shortId = (r.round_id || "").slice(0,8);
      const started = r.started_at ? new Date(r.started_at).toLocaleString() : 'n/a';
      const crash = r.crash_point ? Number(r.crash_point).toFixed(2) + 'x' : 'running';
      item.innerHTML = `<div><strong>${shortId}</strong><div class="meta">${started}</div></div><div class="meta">${crash}</div>`;
      item.onclick = () => showRoundDetails(r.round_id);
      container.appendChild(item);
    });
  }catch(e){ console.error("loadHistory", e); document.getElementById("historyContainer").innerHTML = '<div class="meta">Error</div>'; }
}

async function showRoundDetails(roundId){
  try{
    document.getElementById("roundBody").innerHTML = '<div class="meta">Loading‚Ä¶</div>';
    showRoundModal();
    const res = await fetch(`${API}/game/rounds/${encodeURIComponent(roundId)}`);
    const data = await res.json().catch(()=>null);
    if (!res.ok || !data || !data.round) { document.getElementById("roundBody").innerHTML = '<div class="meta">Unable to load</div>'; return; }
    const r = data.round; const bets = data.bets || [];
    const started = r.started_at ? new Date(r.started_at).toLocaleString() : 'n/a';
    const ended = r.ended_at ? new Date(r.ended_at).toLocaleString() : 'n/a';
    let html = `<div class="meta"><strong>Started:</strong> ${started}<br/><strong>Ended:</strong> ${ended}<br/><strong>Crash:</strong> ${r.crash_point ?? 'running'}</div>`;
    html += `<h4 style="margin-top:8px;">Bets (${bets.length})</h4>`;
    if (!bets.length) html += '<div class="meta">No bets recorded</div>'; else {
      bets.forEach(b => {
        html += `<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${b.user_id ? b.user_id.slice(0,8) : 'guest'}</strong> ‚Äî ${Number(b.bet_amount).toFixed(2)} ZMW <span class="meta">(${b.status})</span>`;
        if (b.payout) html += `<div class="meta">payout: ${Number(b.payout).toFixed(2)}</div>`;
        html += '</div>';
      });
    }
    document.getElementById("roundBody").innerHTML = html;
  }catch(e){ console.error("showRoundDetails", e); document.getElementById("roundBody").innerHTML = '<div class="meta">Error loading</div>'; }
}

/* Public metrics fetch (header) */
async function fetchPublicMetrics(){
  try{
    const res = await fetch(`${API}/metrics/public`);
    const m = await res.json().catch(()=>null);
    if (res.ok && m) document.getElementById("metrics").textContent = `B:${m.totalBets} V:${m.totalVolume} P:${m.totalPayouts}`;
    else document.getElementById("metrics").textContent = '';
  }catch(e){ document.getElementById("metrics").textContent = ''; }
}
fetchPublicMetrics();
setInterval(fetchPublicMetrics, 60_000);

/* small UX: close modal by clicking backdrop */
document.querySelectorAll(".modal").forEach(m => m.addEventListener("click", (ev) => { if (ev.target === m) m.style.display = "none"; }));

/* initial UI update and balance refresh */
updateUI();
refreshBalance();
</script>
</body>
</html>
